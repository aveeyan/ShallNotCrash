<html>
<head>
    <meta charset="UTF-8">
    <title>ShallNotCrash HUD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <style>
        :root {
            --panel-bg: rgba(30,40,60,0.92); --border-color: rgba(160,174,192,0.4);
            --text-primary: #E2E8F0; --text-secondary: #A0AEC0; --color-normal: #48BB78;
            --color-warning: #FFA500; --color-danger: #F56565; --color-info: #667EEA;
            --color-highlight: #A3BFFA; --color-glow: #FF69B4;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #1A202C; overflow: hidden; }
        #map { width: 100vw; height: 100vh; z-index: 0; background-color: #4A5568; }
        .plane-emoji { font-size: 2rem; text-shadow: 0 2px 5px rgba(0,0,0,0.4); transform-origin: center center; }
        .panel { background: var(--panel-bg); color: var(--text-primary); border-radius: 12px; padding: 15px; z-index: 1001; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 1px solid var(--border-color); }
        #left-stack { position: absolute; top: 18px; left: 18px; display: flex; flex-direction: column; gap: 15px; z-index: 1002; }
        #right-stack { position: absolute; top: 18px; right: 18px; width: 320px; display: flex; flex-direction: column; gap: 15px; z-index: 1002;}
        #sites-panel { display: none; }
        .button { padding: 8px 16px; font-size: 0.9rem; font-weight: 600; border-radius: 7px; color: #fff; border: none; cursor: pointer; width: 100%; transition: all 0.2s ease; }
        .button:disabled { background: #718096 !important; cursor: not-allowed; }
        .blinking-border { animation: blink-animation 1s steps(5, start) infinite; }
        @keyframes blink-animation { to { border-color: transparent; } }
        #emergency-details-container { margin-top: 15px; text-align: left; font-size: 0.8rem; max-height: 180px; overflow-y: auto; border-top: 1px solid var(--border-color); padding-top: 10px; font-family: 'SF Mono', 'Consolas', monospace; }
        .detail-item { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 2px 4px; border-radius: 3px; }
        #sites-list { list-style: none; padding: 0; margin: 10px 0 0 0; max-height: 260px; overflow-y: auto; }
        .site-item { padding: 10px; border-radius: 6px; border-bottom: 1px solid #4A5568; cursor: pointer; transition: background-color 0.2s; }
        .site-item:last-child { border-bottom: none; }
        .site-item.hovered { background-color: var(--color-info); }
        .site-item.selected { background-color: #4A5568; border-left: 4px solid var(--color-highlight); padding-left: 6px; }
        .site-item-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .site-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .site-score { font-size: 0.9em; padding: 3px 7px; border-radius: 10px; }
        .site-details { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; }
    
        /* [UI] Styles for Telemetry Monitor and Guidance Dock */
        #telemetry-monitor { width: 220px; font-size: 0.9rem; }
        .telemetry-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(160, 174, 192, 0.1); }
        .telemetry-item:last-child { border-bottom: none; }
        .telemetry-label { color: var(--text-secondary); }
        .telemetry-value { font-weight: 700; font-family: 'SF Mono', 'Consolas', monospace; }

        #guidance-dock {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; padding: 10px 20px; background: var(--panel-bg);
            border-radius: 15px; border: 1px solid var(--border-color); z-index: 1002;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .guidance-pill { text-align: center; }
        .pill-label { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 5px; }
        .pill-bar {
            width: 180px; height: 22px; background: rgba(0,0,0,0.25);
            border-radius: 6px; position: relative; overflow: hidden;
            border: 1px solid rgba(0,0,0,0.3);
        }
        .pill-bar::before { /* Centerline */
            content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 2px;
            background-color: rgba(255,255,255,0.2); transform: translateX(-50%);
        }
        .pill-needle {
            position: absolute; top: 10%; bottom: 10%; width: 4px; border-radius: 2px;
            background-color: var(--text-primary); transition: left 0.2s linear;
        }
        .pill-fd-needle { /* Flight Director Needle */
             background-color: var(--color-glow);
             box-shadow: 0 0 5px var(--color-glow);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="left-stack">
        <div id="fg-panel" class="panel">
            <strong>FG Status:</strong> <span id="fgstatus" style="color:var(--color-danger); font-weight: bold;">Offline</span>
            <button id="launch-fg" class="button" style="background-color:var(--color-info); margin-top:10px;">Launch FlightGear</button>
            <button id="recenter-map" class="button" style="background-color: #4A5568; margin-top:10px;">Re-center on Plane</button>
        </div>
        <div id="telemetry-monitor" class="panel">
            <div class="telemetry-item"><span class="telemetry-label">Airspeed</span><span id="tm-airspeed" class="telemetry-value">0 KTS</span></div>
            <div class="telemetry-item"><span class="telemetry-label">Altitude</span><span id="tm-altitude" class="telemetry-value">0 FT</span></div>
            <div class="telemetry-item"><span class="telemetry-label">V. Speed</span><span id="tm-vspeed" class="telemetry-value">0 FPM</span></div>
            <div class="telemetry-item"><span class="telemetry-label">G Load</span><span id="tm-gload" class="telemetry-value">0.00 G</span></div>
        </div>
    </div>

    <div id="right-stack">
        <div id="emergency-panel" class="panel">
            <div id="status-display" style="text-align: center; margin-bottom: 15px;">
                <div id="emergency-type" style="font-size: 1.6rem; font-weight: bold;">AWAITING CONNECTION</div>
                <div id="emergency-details" style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">Launch or connect to simulation.</div>
            </div>
            <div id="emergency-details-container"></div>
            <button id="find-sites" class="button" style="background-color:var(--color-info); margin-top:15px;">Find Landing Sites</button>
        </div>
        <div id="sites-panel" class="panel">
            <div style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 5px;">PRIORITIZED SITES</div>
            <ul id="sites-list"></ul>
        </div>
    </div>

    <div id="guidance-dock">
        <div class="guidance-pill">
            <div class="pill-label">ROLL</div>
            <div class="pill-bar">
                <div id="roll-needle" class="pill-needle" style="left: 50%;"></div>
                <div id="roll-fd-needle" class="pill-needle pill-fd-needle" style="left: 50%; display: none;"></div>
            </div>
        </div>
        <div class="guidance-pill">
            <div class="pill-label">PITCH</div>
            <div class="pill-bar">
                <div id="pitch-needle" class="pill-needle" style="left: 50%;"></div>
                <div id="pitch-fd-needle" class="pill-needle pill-fd-needle" style="left: 50%; display: none;"></div>
            </div>
        </div>
        <div class="guidance-pill">
            <div class="pill-label">HEADING</div>
            <div class="pill-bar">
                <div id="heading-fd-needle" class="pill-needle pill-fd-needle" style="left: 50%; display: none;"></div>
            </div>
        </div>
    </div>

<script>
    // --- MAP AND GLOBAL STATE SETUP ---
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([64.05, -22.5], 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(map);
    const planeIcon = L.divIcon({ className: '', html: '<div id="plane-marker" class="plane-emoji">✈️</div>', iconSize: [40, 40], iconAnchor: [20, 20] });
    let planeMarker = L.marker([64.05, -22.5], {icon: planeIcon}).addTo(map);
    let flightTrail = L.polyline([], { color: 'rgba(163, 191, 250, 0.6)', weight: 3 }).addTo(map);

    let selectedSiteId = null, flightPathLayer = null;
    let sitesLayerGroup = L.geoJSON(null).addTo(map);
    let siteSearchTriggered = false, isFollowingPlane = true;
    let mapSiteLayers = {};
    let lastGoodTelemetry = {};

    const ui = {
        fgStatus: document.getElementById('fgstatus'), launchFgBtn: document.getElementById('launch-fg'),
        recenterBtn: document.getElementById('recenter-map'), emergencyPanel: document.getElementById('emergency-panel'),
        emergencyType: document.getElementById('emergency-type'), emergencyDetails: document.getElementById('emergency-details'),
        detailsContainer: document.getElementById('emergency-details-container'), findSitesBtn: document.getElementById('find-sites'),
        sitesPanel: document.getElementById('sites-panel'), sitesList: document.getElementById('sites-list'),
        tmAirspeed: document.getElementById('tm-airspeed'), tmAltitude: document.getElementById('tm-altitude'),
        tmVspeed: document.getElementById('tm-vspeed'), tmGload: document.getElementById('tm-gload'),
        rollNeedle: document.getElementById('roll-needle'), pitchNeedle: document.getElementById('pitch-needle'),
        rollFdNeedle: document.getElementById('roll-fd-needle'), pitchFdNeedle: document.getElementById('pitch-fd-needle'),
        headingFdNeedle: document.getElementById('heading-fd-needle'),
    };
    const EmergencyPattern = { 0: 'NORMAL', 1: 'ENGINE_DEGRADATION', 2: 'FUEL_LEAK', 3: 'STRUCTURAL_FATIGUE', 4: 'ELECTRICAL_FAILURE', 5: 'WEATHER_DISTRESS', 6: 'SYSTEM_CASCADE', 7: 'LOSS_OF_CONTROL' };

    // --- CORE DATA UPDATE AND UI FUNCTIONS ---
    function updateHUD(data) {
        if (!data || !data.lat) return;
        lastGoodTelemetry = data; // Store latest telemetry for other functions to use
        const pos = L.latLng(data.lat, data.lng);
        planeMarker.setLatLng(pos);
        document.getElementById('plane-marker').style.transform = `rotate(${data.heading || 0}deg)`;
        
        const trailCoords = flightTrail.getLatLngs();
        if (!trailCoords.length || pos.distanceTo(trailCoords[trailCoords.length - 1]) > 20) {
            trailCoords.push(pos);
            if (trailCoords.length > 300) trailCoords.shift();
            flightTrail.setLatLngs(trailCoords);
        }
        
        if (isFollowingPlane) {
            map.panTo(pos, { animate: true, duration: 0.5 });
        }
        
        const isConnected = data.fg_connected === true;
        ui.fgStatus.textContent = isConnected ? "Online" : "Offline";
        ui.fgStatus.style.color = isConnected ? 'var(--color-normal)' : 'var(--color-danger)';
        ui.launchFgBtn.disabled = isConnected;

        updateEmergencyStatus(data);
        updateTelemetryDetails(data);
        updateTelemetryMonitor(data.raw_telemetry || {});
        updateGuidanceDock(data.raw_telemetry || {});
    }

    function updateTelemetryMonitor(telemetry) {
        ui.tmAirspeed.textContent = `${(telemetry.airspeed || 0).toFixed(0)} KTS`;
        ui.tmAltitude.textContent = `${(telemetry.altitude || 0).toFixed(0)} FT`;
        ui.tmVspeed.textContent = `${(telemetry.vspeed_fpm || 0).toFixed(0)} FPM`;
        ui.tmGload.textContent = `${(telemetry.g_load || 0).toFixed(2)} G`;
    }

    function updateGuidanceDock(telemetry) {
        const rollPercent = (((telemetry.roll || 0) + 60) / 120) * 100;
        ui.rollNeedle.style.left = `${Math.max(0, Math.min(100, rollPercent))}%`;
        const pitchPercent = (((telemetry.pitch || 0) + 20) / 40) * 100;
        ui.pitchNeedle.style.left = `${Math.max(0, Math.min(100, pitchPercent))}%`;
    }
    
    function updateGuidanceFD(guidance) {
        const hasGuidance = guidance && guidance.roll_command !== undefined;
        ui.rollFdNeedle.style.display = hasGuidance ? 'block' : 'none';
        ui.pitchFdNeedle.style.display = hasGuidance ? 'block' : 'none';
        ui.headingFdNeedle.style.display = hasGuidance ? 'block' : 'none';
        if (!hasGuidance) return;
        
        const rollFdPercent = ((guidance.roll_command + 25) / 50) * 100;
        ui.rollFdNeedle.style.left = `${rollFdPercent}%`;
        const pitchFdPercent = ((guidance.pitch_command + 10) / 20) * 100;
        ui.pitchFdNeedle.style.left = `${pitchFdPercent}%`;
        
        const currentHdg = (lastGoodTelemetry.raw_telemetry && lastGoodTelemetry.raw_telemetry.heading) || 0;
        const desiredHdg = guidance.desired_heading || 0;
        let hdgDiff = desiredHdg - currentHdg;
        if (hdgDiff > 180) hdgDiff -= 360; 
        if (hdgDiff < -180) hdgDiff += 360;
        const headingFdPercent = ((hdgDiff + 45) / 90) * 100; // Center is 0 diff, bar shows +/- 45 deg range
        ui.headingFdNeedle.style.left = `${Math.max(0, Math.min(100, headingFdPercent))}%`;
    }

    function updateEmergencyStatus(data) {
        const emergency = data.emergency_result || {};
        const status = data.system_status || {};
        const type = EmergencyPattern[emergency.pattern_type] || 'NORMAL';
        const isEmergency = type !== 'NORMAL' && type !== 'GRACE_PERIOD';

        ui.emergencyPanel.className = 'panel';
        ui.emergencyType.style.color = 'var(--text-primary)';
        ui.findSitesBtn.className = 'button';
        ui.findSitesBtn.style.backgroundColor = 'var(--color-info)';
        ui.findSitesBtn.textContent = 'Find Landing Sites';
        ui.emergencyPanel.style.borderColor = 'var(--border-color)';

        if (data.fg_connected && status.grace_period_remaining > 0) {
            ui.emergencyType.textContent = 'GRACE PERIOD';
            ui.emergencyDetails.textContent = `${status.grace_period_remaining.toFixed(1)}s remaining`;
            ui.emergencyType.style.color = 'var(--color-warning)';
        } else if (isEmergency) {
            ui.emergencyType.textContent = type.replace(/_/g, ' ');
            ui.emergencyDetails.textContent = `Confidence: ${(emergency.probability * 100).toFixed(0)}%`;
            ui.emergencyType.style.color = 'var(--color-danger)';
            ui.emergencyPanel.classList.add('blinking-border');
            ui.emergencyPanel.style.borderColor = 'var(--color-danger)';
            ui.findSitesBtn.style.backgroundColor = 'var(--color-danger)';
            if (!siteSearchTriggered) {
                findAndDisplaySites();
                siteSearchTriggered = true;
            }
        } else if (type === 'NORMAL') {
            ui.emergencyType.textContent = 'SYSTEMS NORMAL';
            ui.emergencyType.style.color = 'var(--color-normal)';
            ui.emergencyDetails.textContent = 'All systems nominal.';
        } else if (!data.fg_connected){
            ui.emergencyType.textContent = 'AWAITING CONNECTION';
            ui.emergencyDetails.textContent = 'Launch or connect to simulation.';
        }
    }

    function updateTelemetryDetails(data) {
        const telemetry = data.raw_telemetry || {};
        const scores = data.anomaly_scores || {};
        const orderedKeys = ['rpm', 'oil_pressure', 'fuel_flow', 'g_load', 'vibration', 'bus_volts', 'oil_temp', 'cht'];
        ui.detailsContainer.innerHTML = '';
        if (Object.keys(telemetry).length > 0 && Object.keys(scores).length > 0) {
            orderedKeys.forEach(key => {
                if(telemetry.hasOwnProperty(key)) {
                    const score = (scores[key] && scores[key].normalized_score !== undefined) ? scores[key].normalized_score : 0;
                    const scoreColor = score > 0.7 ? 'var(--color-danger)' : (score > 0.5 ? 'var(--color-warning)' : 'var(--text-secondary)');
                    const item = document.createElement('div');
                    item.className = 'detail-item';
                    if (score > 0.5) item.style.backgroundColor = 'rgba(255, 69, 0, 0.2)';
                    item.innerHTML = `<span style="color:var(--text-secondary)">${key.replace(/_/g, ' ').toUpperCase()}</span><span><span style="font-weight:bold">${telemetry[key].toFixed(2)}</span><span style="color:${scoreColor};font-weight:bold;width:45px;display:inline-block;text-align:right">(${(score * 100).toFixed(0)}%)</span></span>`;
                    ui.detailsContainer.appendChild(item);
                }
            });
        } else {
            ui.detailsContainer.innerHTML = `<div style="color: var(--text-secondary); text-align: center;">Awaiting telemetry...</div>`;
        }
    }

    // --- SITE FINDING AND PATH PLANNING ---
    function findAndDisplaySites() {
        isFollowingPlane = false;
        ui.findSitesBtn.disabled = true;
        ui.findSitesBtn.textContent = "Searching...";
        fetch('/sites').then(res => res.ok ? res.json() : Promise.reject('Failed to load sites')).then(geojson => {
            geojson.features.sort((a, b) => (b.properties.priority_score || 0) - (a.properties.priority_score || 0));
            sitesLayerGroup.clearLayers();
            ui.sitesList.innerHTML = '';
            mapSiteLayers = {};

            sitesLayerGroup = L.geoJSON(geojson, {
                style: f => ({ color: f.properties.display_color, weight: 2, fillOpacity: 0.6 }),
                onEachFeature: (feature, layer) => {
                    const siteId = feature.properties.id;
                    mapSiteLayers[siteId] = layer;
                    layer.on({
                        click: () => handleSiteClick(feature, layer),
                        mouseover: (e) => highlightSite(siteId, true),
                        mouseout: (e) => highlightSite(siteId, false),
                    });
                    addSiteToList(feature, layer);
                }
            }).addTo(map);

            if (geojson.features.length > 0) {
                map.fitBounds(sitesLayerGroup.getBounds().extend(planeMarker.getLatLng()).pad(0.2));
                ui.sitesPanel.style.display = 'block';
            }
        }).catch(err => {
            console.error(err);
            alert("Could not load or display landing sites.");
        }).finally(() => { 
            ui.findSitesBtn.disabled = false; 
            ui.findSitesBtn.textContent = 'Find Landing Sites';
        });
    }

    function addSiteToList(feature, layer) {
        const props = feature.properties;
        const listItem = document.createElement('li');
        listItem.className = 'site-item';
        listItem.dataset.siteId = props.id;
        const score = (props.safety_report.safety_score || 0).toFixed(0);
        const scoreColor = props.display_color || '#667EEA';
        const textColor = ['#FFFF00','#FFA500'].includes(scoreColor.toUpperCase()) ? '#333' : '#FFF';

        listItem.innerHTML = `<div class="site-item-header"><span class="site-name">${props.name}</span><span class="site-score" style="background-color:${scoreColor};color:${textColor};">${score}</span></div><div class="site-details">${props.type.replace(/_/g, ' ')} &bull; ${(props.length_m||0).toFixed(0)}m</div>`;
        
        listItem.addEventListener('click', () => handleSiteClick(feature, layer));
        listItem.addEventListener('mouseover', () => highlightSite(props.id, true));
        listItem.addEventListener('mouseout', () => highlightSite(props.id, false));
        
        ui.sitesList.appendChild(listItem);
    }

    function highlightSite(siteId, isHighlighted) {
        const mapLayer = mapSiteLayers[siteId];
        const listItem = document.querySelector(`.site-item[data-site-id='${siteId}']`);
        if (!mapLayer || !listItem) return;

        listItem.classList.toggle('hovered', isHighlighted);
        if (selectedSiteId === siteId) return;

        if (isHighlighted) {
            mapLayer.setStyle({ color: 'var(--color-glow)', weight: 4, opacity: 1 }).bringToFront();
        } else {
            mapLayer.setStyle({ color: mapLayer.feature.properties.display_color, weight: 2, opacity: 0.6 });
        }
    }

    function handleSiteClick(feature, layer) {
        if (selectedSiteId !== null) {
            const oldLayer = mapSiteLayers[selectedSiteId];
            if (oldLayer) oldLayer.setStyle({ weight: 2, color: oldLayer.feature.properties.display_color, opacity: 0.6 });
            document.querySelector(`.site-item[data-site-id='${selectedSiteId}']`)?.classList.remove('selected');
        }
        selectedSiteId = feature.properties.id;
        document.querySelector(`.site-item[data-site-id='${selectedSiteId}']`)?.classList.add('selected');
        layer.setStyle({ weight: 5, color: 'var(--color-highlight)', opacity: 1 }).bringToFront();
        planAndDisplayPath(selectedSiteId);
    }
    
    function planAndDisplayPath(siteId) {
        isFollowingPlane = false; 
        fetch('/plan_path', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ site_id: siteId }) })
        .then(res => res.ok ? res.json() : Promise.reject('Path planning failed')).then(data => {
            if (data && data.waypoints && data.waypoints.length > 0) {
                if (flightPathLayer) flightPathLayer.remove();
                flightPathLayer = L.polyline(data.waypoints, { color: '#00FFFF', weight: 4, opacity: 0.9, dashArray: '5, 10' }).addTo(map);
                map.fitBounds(L.latLngBounds([planeMarker.getLatLng(), ...data.waypoints]).pad(0.2));
            }
        });
    }

    function updatePath() {
        if (selectedSiteId === null) return;
        fetch('/plan_path', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ site_id: selectedSiteId }) })
        .then(res => res.ok ? res.json() : Promise.resolve(null)).then(data => {
            if (data && data.waypoints && data.waypoints.length > 0) {
                if (flightPathLayer) flightPathLayer.setLatLngs(data.waypoints);
                else flightPathLayer = L.polyline(data.waypoints, { color: '#00FFFF', weight: 4, opacity: 0.9, dashArray: '5, 10' }).addTo(map);
            }
        });
    }

    // --- EVENT LISTENERS AND TIMERS ---
    ui.launchFgBtn.addEventListener('click', () => {
        ui.launchFgBtn.disabled = true;
        ui.launchFgBtn.textContent = "Launching...";
        fetch('/launch_fg', { method: 'POST' }).then(r => r.json())
            .then(data => { if (!data.success) alert("Launch failed: " + data.error); })
            .finally(() => { ui.launchFgBtn.textContent = "Launch FlightGear"; });
    });
    map.on('dragstart zoomstart', () => { isFollowingPlane = false; });
    ui.recenterBtn.addEventListener('click', () => {
        isFollowingPlane = true;
        if (planeMarker) map.setView(planeMarker.getLatLng(), map.getZoom(), {animate: true, duration: 0.5});
    });
    ui.findSitesBtn.addEventListener('click', findAndDisplaySites);
    
    // --- Main Timers ---
    setInterval(() => fetch('/position').then(r => r.json()).then(updateHUD), 500); // Update telemetry
    setInterval(updatePath, 2500); // Update flight path
    setInterval(() => { // Update flight director
        if (selectedSiteId !== null) {
            fetch('/guidance').then(r => r.ok ? r.json() : Promise.resolve(null)).then(updateGuidanceFD);
        } else {
            updateGuidanceFD(null); // Hide FD if no path is selected
        }
    }, 250);

</script>
</body>
</html>
