<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <title>ShallNotCrash HUD</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; z-index: 0; background-color: #aacbff; }
        .plane-emoji { font-size: 1.8rem; line-height: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); transform-origin: center center; will-change: transform; user-select: none; pointer-events: none; }
        .panel { background: rgba(30,40,60,0.92); color: #fff; border-radius: 12px; padding: 15px; z-index: 1001; box-shadow: 0 4px 16px rgba(0,0,0,0.12); border: 1px solid rgba(160,174,192,0.4); }
        #telemetry-panel { position: absolute; top: 18px; left: 18px; min-width: 250px; }
        #emergency-panel { position: absolute; top: 18px; right: 18px; min-width: 250px; text-align: center; }
        .button { margin-top: 15px; padding: 8px 16px; font-size: 1rem; border-radius: 7px; color: #fff; border: none; cursor: pointer; width: 100%; transition: all 0.2s; }
        .button-primary { background: #667eea; }
        .button-secondary { background: #4a5568; }
        .button:disabled { background: #a0aec0; color: #eee; cursor: not-allowed; opacity: 0.7; }

        #sites-panel {
            position: absolute;
            top: 150px;
            right: 18px;
            width: 280px;
            display: none;
        }
        #sites-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            max-height: 260px;
            overflow-y: auto;
        }
        .site-item {
            padding: 10px;
            border-radius: 6px;
            border-bottom: 1px solid #4a5568;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .site-item:last-child {
            border-bottom: none;
        }
        .site-item:hover {
            background-color: #4a5568;
        }
        .site-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .site-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        .site-score {
            font-size: 0.9em;
            padding: 3px 7px;
            border-radius: 10px;
        }
        .site-details {
            font-size: 0.8em;
            color: #a0aec0;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="telemetry-panel" class="panel">
        <div class="telemetry-item">
            <span class="telemetry-label">FG Status</span>
            <span id="fgstatus" style="color:#f56565; font-weight: bold;">Offline</span>
        </div>
        <button id="start-fg" class="button button-primary">Start FlightGear</button>
    </div>
    <div id="emergency-panel" class="panel">
        <div style="font-size: 1.2rem; color: #a0aec0; margin-bottom: 10px;">SYSTEM STATUS</div>
        <button id="find-sites" class="button button-secondary">Find Landing Sites</button>
    </div>

    <div id="sites-panel" class="panel">
        <div style="font-size: 1.2rem; color: #a0aec0; margin-bottom: 5px;">PRIORITIZED SITES</div>
        <div id="sites-list">
            </div>
    </div>

<script>
    // --- Map and Marker Initialization ---
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([64.05, -22.5], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
    const PlaneIcon = L.divIcon({ className: '', html: '<div id="plane-marker" class="plane-emoji">✈️</div>', iconSize: [40, 40], iconAnchor: [20, 20] });
    let planeMarker = L.marker([64.05, -22.5], {icon: PlaneIcon}).addTo(map);

    // --- Global State Variables ---
    let selectedSiteLayer = null;
    let selectedSiteCoords = null; // For the direct navigation line
    let navLine = null; // The direct navigation line layer
    let flightPathLayer = null; // The generated flight path layer
    let activePathRecalculation = null; // Timer for recalculating path

    // --- Layer Styles ---
    const defaultSiteStyle = (feature) => {
        const color = feature.properties.display_color || '#FF8C00';
        return { color: color, fillColor: color, weight: 2, fillOpacity: 0.65, opacity: 1 };
    };
    const selectedSiteStyle = { color: '#FFFFFF', weight: 4, fillOpacity: 0.8, opacity: 1 };

    // --- GeoJSON Layer for Landing Sites ---
    let sitesLayerGroup = L.geoJSON(null, {
        style: defaultSiteStyle,
        onEachFeature: function (feature, layer) {
            const props = feature.properties;
            const score = (props.safety_report && props.safety_report.safety_score) ? props.safety_report.safety_score.toFixed(0) : 'N/A';
            layer.bindPopup(`<b>${props.name} (${props.type})</b><br>Safety Score: <b>${score}</b>`);

            // --- Unified Click Handler for Site Selection ---
            const siteClickHandler = () => {
                // 1. Update map styles
                if (selectedSiteLayer) {
                    selectedSiteLayer.setStyle(defaultSiteStyle(selectedSiteLayer.feature));
                }
                layer.setStyle(selectedSiteStyle);
                selectedSiteLayer = layer;
                
                // 2. Set coordinates for the simple navigation line
                if (props.center_lat && props.center_lon) {
                    selectedSiteCoords = [props.center_lat, props.center_lon];
                }

                // 3. Plan and display the detailed flight path
                planAndDisplayPath(props.id); 
            };
            layer.on('click', siteClickHandler);

            // --- Create and configure the list item in the side panel ---
            const sitesList = document.getElementById('sites-list');
            const listItem = document.createElement('div');
            listItem.className = 'site-item';
            
            const scoreColor = props.display_color || '#a0aec0';
            const textColor = (['#FFFF00', '#FFA500', '#32CD32'].includes(scoreColor)) ? '#333' : '#FFF';
            
            listItem.innerHTML = `
                <div class="site-item-header">
                    <span class="site-name">${props.name}</span>
                    <span class="site-score" style="background-color: ${scoreColor}; color: ${textColor};">${score}</span>
                </div>
                <div class="site-details">
                    ${props.type.replace('_', ' ')} &bull; ${(props.length_m || 0).toFixed(0)}m long
                </div>`;
            
            listItem.addEventListener('click', siteClickHandler);
            listItem.addEventListener('mouseover', () => {
                layer.openPopup();
                layer.setStyle({ weight: 4, color: '#FFFF00' });
            });
            listItem.addEventListener('mouseout', () => {
                layer.closePopup();
                layer.setStyle(layer === selectedSiteLayer ? selectedSiteStyle : defaultSiteStyle(feature));
            });
            
            sitesList.appendChild(listItem);
        }
    }).addTo(map);

    // --- Helper Functions ---
    function updateNavLine() {
        if (!selectedSiteCoords) return;
        const planePos = planeMarker.getLatLng();
        const destPos = L.latLng(selectedSiteCoords[0], selectedSiteCoords[1]);
        if (!navLine) {
            navLine = L.polyline([planePos, destPos], { color: '#FF00FF', weight: 3, opacity: 0.8, dashArray: '10, 10' }).addTo(map);
        } else {
            navLine.setLatLngs([planePos, destPos]);
        }
    }

    function planAndDisplayPath(siteId) {
        if (activePathRecalculation) clearInterval(activePathRecalculation);

        const fetchAndDraw = () => {
            fetch('/plan_path', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ site_id: siteId })
            })
            .then(res => res.ok ? res.json() : Promise.reject('Path planning failed on server.'))
            .then(data => {
                if (data.waypoints && data.waypoints.length > 0) {
                    if (flightPathLayer) {
                        flightPathLayer.setLatLngs(data.waypoints);
                    } else {
                        flightPathLayer = L.polyline(data.waypoints, { color: '#00FFFF', weight: 4, opacity: 0.9, dashArray: '5, 10' }).addTo(map);
                    }
                }
            })
            .catch(error => console.error('Error fetching flight path:', error));
        };
        
        fetchAndDraw(); // Fetch immediately on selection
        activePathRecalculation = setInterval(fetchAndDraw, 7000); // Then update every 7 seconds
    }

    function findAndDisplaySites() {
        const btn = document.getElementById('find-sites');
        btn.disabled = true;
        btn.textContent = "Loading Sites...";

        fetch('/sites')
            .then(response => response.ok ? response.json() : Promise.reject('Failed to load sites.'))
            .then(geojson_data => {
                geojson_data.features.sort((a, b) => (b.properties.priority_score || 0) - (a.properties.priority_score || 0));
                
                sitesLayerGroup.clearLayers();
                document.getElementById('sites-list').innerHTML = '';
                sitesLayerGroup.addData(geojson_data);

                const sitesPanel = document.getElementById('sites-panel');
                if (geojson_data.features.length > 0) {
                    map.fitBounds(sitesLayerGroup.getBounds().pad(0.1));
                    sitesPanel.style.display = 'block';
                } else {
                    sitesPanel.style.display = 'none';
                }
            })
            .catch(error => { console.error('Error finding sites:', error); alert(error.message); })
            .finally(() => { btn.disabled = false; btn.textContent = "Find Landing Sites"; });
    }

    // --- Main Application Loop ---
    function updateHUD() {
        fetch('/position').then(r => r.json()).then(data => {
            if (data && data.lat !== null) {
                const pos = [data.lat, data.lng];
                planeMarker.setLatLng(pos);
                if (!selectedSiteLayer) map.setView(pos, map.getZoom(), {animate: false});
                
                document.getElementById('plane-marker').style.transform = `rotate(${data.heading || 0}deg)`;

                // "Lazy" visual update for both nav line and flight path
                if (selectedSiteLayer) updateNavLine();
                if (flightPathLayer) {
                    const currentPath = flightPathLayer.getLatLngs();
                    if (currentPath.length > 1) {
                        currentPath[0] = L.latLng(data.lat, data.lng);
                        flightPathLayer.setLatLngs(currentPath);
                    }
                }
            }
            const fgConnected = (data && data.fg_connected === true);
            const fgStatusEl = document.getElementById('fgstatus');
            fgStatusEl.textContent = fgConnected ? "Online" : "Offline";
            fgStatusEl.style.color = fgConnected ? "#48bb78" : "#f56565";
            document.getElementById('start-fg').disabled = fgConnected;
        });
    }

    // --- Initial Setup and Event Listeners ---
    setInterval(updateHUD, 200);
    updateHUD();
    document.getElementById('find-sites').onclick = findAndDisplaySites;
    document.getElementById('start-fg').onclick = function() {
        const btn = this; btn.disabled = true; btn.textContent = "Starting...";
        fetch('/start_fg', {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    alert("Failed to start FlightGear: " + (data.error || "Unknown error"));
                    btn.disabled = false; btn.textContent = "Start FlightGear";
                }
            });
    };
</script>
</body>
</html>
