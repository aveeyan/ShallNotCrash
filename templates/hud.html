<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <title>ShallNotCrash HUD</title>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; z-index: 0; background-color: #aacbff; }
        .plane-emoji { font-size: 1.8rem; line-height: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); transform-origin: center center; will-change: transform; user-select: none; pointer-events: none; }
        .stat-panel { position: absolute; top: 18px; left: 18px; background: rgba(30,40,60,0.92); color: #fff; border-radius: 12px; padding: 16px 22px; font-size: 1.1rem; z-index: 1001; box-shadow: 0 4px 16px rgba(0,0,0,0.12); font-family: 'Segoe UI', Arial, sans-serif; min-width: 220px; }
        .stat-label { color: #a0aec0; font-size: 0.97rem; margin-right: 6px; }
        #start-fg { margin-top: 10px; padding: 7px 16px; font-size: 1rem; border-radius: 7px; background: #667eea; color: #fff; border: none; cursor: pointer; width: 100%; transition: all 0.2s; }
        #start-fg:disabled { background: #a0aec0; color: #eee; cursor: not-allowed; opacity: 0.7; }

        /* --- [NEW] Styles for Attitude Indicators --- */
        .attitude-indicators { display: flex; align-items: center; justify-content: center; margin-top: 15px; margin-bottom: 5px; }
        .gyro-container { width: 100px; height: 100px; border: 2px solid #a0aec0; border-radius: 50%; position: relative; overflow: visible; background: linear-gradient(180deg, #87ceeb 50%, #8b4513 50%); }
        .gyro-plane { width: 80%; height: 80%; position: absolute; top: 10%; left: 10%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; background-position: center; transition: transform 0.1s linear; }
        .gyro-ticks { border-top: 2px solid white; position: absolute; top: 50%; left: 50%; transform-origin: 0 0; }
        .pitch-container { width: 20px; height: 100px; border: 2px solid #a0aec0; border-radius: 10px; margin-left: 10px; position: relative; background-color: #2d3748; }
        .pitch-zero-line { width: 100%; border-top: 2px solid white; position: absolute; top: 50%; left: 0; transform: translateY(-50%); }
        .pitch-indicator-bar { width: 80%; height: 4px; background-color: #667eea; border-radius: 2px; position: absolute; left: 10%; top: 50%; transform: translateY(-50%); transition: top 0.1s linear; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="stat-panel">
        <div><span class="stat-label">Heading:</span><span id="heading">-</span>°</div>
        <div><span class="stat-label">Speed:</span><span id="speed">-</span> kts</div>
        <div><span class="stat-label">Altitude:</span><span id="altitude">-</span> ft</div>
        <div><span class="stat-label">FG:</span><span id="fgstatus" style="color:#f56565;">Offline</span></div>
        <div class="attitude-indicators">
            <div class="gyro-container" title="Roll Angle">
                <div id="gyro-plane" class="gyro-plane"></div>
                <div class="gyro-ticks" style="width: 20%; transform: translate(-50%, -50%) rotate(-45deg);"></div>
                <div class="gyro-ticks" style="width: 10%; transform: translate(-50%, -50%) rotate(-22.5deg);"></div>
                <div class="gyro-ticks" style="width: 10%; transform: translate(-50%, -50%) rotate(22.5deg);"></div>
                <div class="gyro-ticks" style="width: 20%; transform: translate(-50%, -50%) rotate(45deg);"></div>
                <div class="gyro-ticks" style="width: 25%; border-width: 3px; transform: translate(-50%, -50%) rotate(0deg);"></div>
            </div>
            <div class="pitch-container" title="Pitch Angle">
                <div class="pitch-zero-line"></div>
                <div id="pitch-indicator" class="pitch-indicator-bar"></div>
            </div>
        </div>
        <button id="start-fg">Start FlightGear</button>
    </div>
    <script>
        // --- (Map setup is unchanged) ---
        const initialPos = [64.05, -22.5];
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView(initialPos, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
        const PlaneIcon = L.divIcon({ className: '', html: '<div id="plane-marker" class="plane-emoji">✈️</div>', iconSize: [40, 40], iconAnchor: [20, 20] });
        let planeMarker = L.marker(initialPos, {icon: PlaneIcon}).addTo(map);
        let trailLine = L.polyline([], {color: '#48bb78', weight: 4, opacity: 0.7}).addTo(map);
        let trailCoords = [];

        function updateHUD() {
            fetch('/position')
                .then(r => r.json())
                .then(data => {
                    // --- (HUD text updates are unchanged) ---
                    document.getElementById('heading').textContent = data.heading !== null ? Math.round(data.heading) : '-';
                    document.getElementById('speed').textContent = data.speed !== null ? Math.round(data.speed) : '-';
                    document.getElementById('altitude').textContent = data.altitude !== null ? Math.round(data.altitude) : '-';
                    document.getElementById('fgstatus').textContent = data.fg_connected ? "Online" : "Offline";
                    document.getElementById('fgstatus').style.color = data.fg_connected ? "#48bb78" : "#f56565";
                    const startBtn = document.getElementById('start-fg');
                    startBtn.disabled = data.fg_connected;
                    startBtn.textContent = data.fg_connected ? "FlightGear Running" : "Start FlightGear";

                    if (data.lat !== null && data.lng !== null) {
                        const pos = [data.lat, data.lng];
                        planeMarker.setLatLng(pos);
                        map.setView(pos, map.getZoom(), {animate: false});
                        if (data.fg_connected && (trailCoords.length === 0 || trailCoords[trailCoords.length - 1][0] !== data.lat)) {
                            trailCoords.push([data.lat, data.lng]);
                            trailLine.setLatLngs(trailCoords);
                        }
                        
                        // --- Update indicators ---
                        let markerDiv = document.getElementById('plane-marker');
                        if (markerDiv) markerDiv.style.transform = `rotate(${data.heading || 0}deg)`;
                        let gyroPlane = document.getElementById('gyro-plane');
                        if (gyroPlane) gyroPlane.style.transform = `rotate(${data.roll || 0}deg)`;
                        
                        // [THE FIX] Update the new pitch indicator
                        let pitchIndicator = document.getElementById('pitch-indicator');
                        if (pitchIndicator) {
                            const pitch = data.pitch || 0;
                            // Clamp pitch between -20 and +20 degrees for visualization
                            const clampedPitch = Math.max(-20, Math.min(20, pitch));
                            // Map the pitch value (-20 to +20) to a percentage (100% to 0%) for the 'top' CSS property
                            const pitchPercent = 50 - (clampedPitch * 2.5);
                            pitchIndicator.style.top = `${pitchPercent}%`;
                        }
                    }
                });
        }
        
        setInterval(updateHUD, 100);
        updateHUD();
        document.getElementById('start-fg').onclick = function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = "Starting...";
            fetch('/start_fg', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert("FlightGear started and connected!");
                    } else {
                        alert("Failed to start FlightGear: " + (data.error || data.message || "Unknown error"));
                        btn.disabled = false;
                        btn.textContent = "Start FlightGear";
                    }
                });
        };
    </script>
</body>
</html>