<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <title>ShallNotCrash HUD</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; z-index: 0; background-color: #aacbff; }
        .plane-emoji { font-size: 1.8rem; line-height: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); transform-origin: center center; will-change: transform; user-select: none; pointer-events: none; }
        .panel { background: rgba(30,40,60,0.92); color: #fff; border-radius: 12px; padding: 15px; z-index: 1001; box-shadow: 0 4px 16px rgba(0,0,0,0.12); border: 1px solid rgba(160,174,192,0.4); }
        #telemetry-panel { position: absolute; top: 18px; left: 18px; min-width: 250px; }
        #emergency-panel { position: absolute; top: 18px; right: 18px; min-width: 250px; text-align: center; }
        .button { margin-top: 15px; padding: 8px 16px; font-size: 1rem; border-radius: 7px; color: #fff; border: none; cursor: pointer; width: 100%; transition: all 0.2s; }
        .button-primary { background: #667eea; }
        .button-secondary { background: #4a5568; }
        .button:disabled { background: #a0aec0; color: #eee; cursor: not-allowed; opacity: 0.7; }

        /* --- [NEW] Styles for the Sites Panel --- */
        #sites-panel {
            position: absolute;
            top: 150px; /* Position below the emergency panel */
            right: 18px;
            width: 280px;
            display: none; /* Hidden by default */
        }
        #sites-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            max-height: 260px; /* Approx. 4 items at 65px each */
            overflow-y: auto;
        }
        .site-item {
            padding: 10px;
            border-radius: 6px;
            border-bottom: 1px solid #4a5568;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .site-item:last-child {
            border-bottom: none;
        }
        .site-item:hover {
            background-color: #4a5568;
        }
        .site-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .site-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        .site-score {
            font-size: 0.9em;
            padding: 3px 7px;
            border-radius: 10px;
            background-color: #38a169;
        }
        .site-details {
            font-size: 0.8em;
            color: #a0aec0;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="telemetry-panel" class="panel">
        <div class="telemetry-item">
            <span class="telemetry-label">FG Status</span>
            <span id="fgstatus" style="color:#f56565; font-weight: bold;">Offline</span>
        </div>
        <button id="start-fg" class="button button-primary">Start FlightGear</button>
    </div>
    <div id="emergency-panel" class="panel">
        <div style="font-size: 1.2rem; color: #a0aec0; margin-bottom: 10px;">SYSTEM STATUS</div>
        <button id="find-sites" class="button button-secondary">Find Landing Sites</button>
    </div>

    <div id="sites-panel" class="panel">
        <div style="font-size: 1.2rem; color: #a0aec0; margin-bottom: 5px;">PRIORITIZED SITES</div>
        <div id="sites-list">
            </div>
    </div>

<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([64.05, -22.5], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
    const PlaneIcon = L.divIcon({ className: '', html: '<div id="plane-marker" class="plane-emoji">✈️</div>', iconSize: [40, 40], iconAnchor: [20, 20] });
    let planeMarker = L.marker([64.05, -22.5], {icon: PlaneIcon}).addTo(map);

    let selectedSiteLayer = null;
    let navLine = null;
    let selectedSiteCoords = null;

    const defaultSiteStyle = (feature) => {
        const color = feature.properties.display_color || '#FF8C00';
        return { color: color, fillColor: color, weight: 2, fillOpacity: 0.65, opacity: 1 };
    };
    const selectedSiteStyle = {
        color: '#FFFFFF',
        weight: 4,
        fillOpacity: 0.8,
        opacity: 1
    };
    
    // --- [MODIFIED] onEachFeature now also populates the sites list ---
    let sitesLayerGroup = L.geoJSON(null, {
        style: defaultSiteStyle,
        onEachFeature: function (feature, layer) {
            const props = feature.properties;
            const score = (props.safety_report && props.safety_report.safety_score) ? props.safety_report.safety_score.toFixed(0) : 'N/A';
            const popupContent = `<b>${props.name} (${props.type})</b><br>Safety Score: <b>${score}</b>`;
            layer.bindPopup(popupContent);

            layer.on('click', function(e) {
                if (selectedSiteLayer) {
                    selectedSiteLayer.setStyle(defaultSiteStyle(selectedSiteLayer.feature));
                }
                layer.setStyle(selectedSiteStyle);
                selectedSiteLayer = layer;
                const center = feature.properties;
                if (center.center_lat && center.center_lon) {
                    selectedSiteCoords = [center.center_lat, center.center_lon];
                    updateNavLine();
                }
            });

            // --- [NEW] Create and append the corresponding list item ---
            const sitesList = document.getElementById('sites-list');
            const listItem = document.createElement('div');
            listItem.className = 'site-item';

            // --- [NEW] Get the score-based color from properties ---
            const scoreColor = props.display_color || '#a0aec0';
            // Note for text on bright backgrounds like yellow
            const textColor = (scoreColor === '#FFFF00' || scoreColor === '#FFA500' || scoreColor === '#32CD32') ? '#333' : '#FFF'
            
            listItem.innerHTML = `
                <div class="site-item-header">
                    <span class="site-name">${props.name}</span>
                    <span class="site-score" style="background-color: ${scoreColor}; color: ${textColor};">${score}</span>
                </div>
                <div class="site-details">
                    ${props.type.replace('_', ' ')} &bull; ${(props.length_m || 0).toFixed(0)}m long
                </div>
            `;
            
            // --- [NEW] Add hover listeners to link list to map ---
            listItem.addEventListener('mouseover', () => {
                layer.openPopup();
                layer.setStyle({ weight: 4, color: '#FFFF00' }); // Highlight with yellow
            });
            listItem.addEventListener('mouseout', () => {
                layer.closePopup();
                // Reset style only if it's not the currently selected layer
                if (layer !== selectedSiteLayer) {
                    layer.setStyle(defaultSiteStyle(feature));
                } else {
                    layer.setStyle(selectedSiteStyle); // Re-apply selected style
                }
            });
            
            sitesList.appendChild(listItem);
        }
    }).addTo(map);
    
    function updateNavLine() {
        if (!selectedSiteCoords) return;
        const planePos = planeMarker.getLatLng();
        const destPos = L.latLng(selectedSiteCoords[0], selectedSiteCoords[1]);
        if (!navLine) {
            navLine = L.polyline([planePos, destPos], { color: '#FF00FF', weight: 3, opacity: 0.8, dashArray: '10, 10' }).addTo(map);
        } else {
            navLine.setLatLngs([planePos, destPos]);
        }
    }

    function updateHUD() {
        fetch('/position').then(r => r.json()).then(data => {
            if (data && data.lat !== null && data.lng !== null) {
                const pos = [data.lat, data.lng];
                planeMarker.setLatLng(pos);
                if (!selectedSiteLayer) {
                    map.setView(pos, map.getZoom(), {animate: false});
                }
                document.getElementById('plane-marker').style.transform = `rotate(${data.heading || 0}deg)`;
                if (selectedSiteLayer) {
                    updateNavLine();
                }
            }
            const fgConnected = (data && data.fg_connected === true);
            document.getElementById('fgstatus').textContent = fgConnected ? "Online" : "Offline";
            document.getElementById('fgstatus').style.color = fgConnected ? "#48bb78" : "#f56565";
            document.getElementById('start-fg').disabled = fgConnected;
        });
    }

    // --- [MODIFIED] This function now sorts the data and shows the panel ---
    function findAndDisplaySites() {
        const btn = document.getElementById('find-sites');
        const sitesPanel = document.getElementById('sites-panel');
        const sitesList = document.getElementById('sites-list');
        btn.disabled = true;
        btn.textContent = "Loading Sites...";

        fetch('/sites')
            .then(response => {
                if (!response.ok) { return response.json().then(err => { throw new Error(err.error || 'Failed to load sites.') }); }
                return response.json();
            })
            .then(geojson_data => {
                // --- [NEW] Sort features by safety score in descending order ---
                geojson_data.features.sort((a, b) => {
                    const scoreA = a.properties.priority_score || 0;
                    const scoreB = b.properties.priority_score || 0;
                    return scoreB - scoreA;
                });

                // Clear previous data
                sitesLayerGroup.clearLayers();
                sitesList.innerHTML = ''; // Clear the list

                sitesLayerGroup.addData(geojson_data);

                if (geojson_data.features.length > 0) {
                    map.fitBounds(sitesLayerGroup.getBounds().pad(0.1));
                    sitesPanel.style.display = 'block'; // Show the panel
                } else {
                    sitesPanel.style.display = 'none'; // Hide if no sites
                }
            })
            .catch(error => { console.error('Error fetching landing sites:', error); alert('Error: ' + error.message); })
            .finally(() => { btn.disabled = false; btn.textContent = "Find Landing Sites"; });
    }

    setInterval(updateHUD, 200);
    updateHUD();
    document.getElementById('find-sites').onclick = findAndDisplaySites;
    document.getElementById('start-fg').onclick = function() {
        const btn = this; btn.disabled = true; btn.textContent = "Starting...";
        fetch('/start_fg', {method: 'POST'}).then(r => r.json()).then(data => {
            if (!data.success) {
                 alert("Failed to start FlightGear: " + (data.error || "Unknown error"));
                 btn.disabled = false; btn.textContent = "Start FlightGear";
            }
        });
    };
</script>
</body>
</html>
