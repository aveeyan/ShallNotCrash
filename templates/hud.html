<html>
<head>
    <meta charset="UTF-8">
    <title>ShallNotCrash HUD</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}" />
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <style>
        :root {
            --panel-bg: rgba(30,40,60,0.92); --border-color: rgba(160,174,192,0.4);
            --text-primary: #E2E8F0; --text-secondary: #A0AEC0; --color-normal: #48BB78;
            --color-warning: #FFA500; --color-danger: #F56565; --color-info: #667EEA;
            --color-highlight: #A3BFFA;
            /* [NEW] Pink glow color for hover highlighting */
            --color-glow: #FF69B4; /* Brighter pink */
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #1A202C; }
        #map { width: 100vw; height: 100vh; z-index: 0; background-color: #4A5568; }
        .plane-emoji { font-size: 2rem; text-shadow: 0 2px 5px rgba(0,0,0,0.4); transform-origin: center center; }
        .panel { background: var(--panel-bg); color: var(--text-primary); border-radius: 12px; padding: 15px; z-index: 1001; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 1px solid var(--border-color); }
        #left-stack { position: absolute; top: 18px; left: 18px; display: flex; flex-direction: column; gap: 15px; z-index: 1002; }
        #right-stack { position: absolute; top: 18px; right: 18px; width: 320px; display: flex; flex-direction: column; gap: 15px; z-index: 1002;}
        #sites-panel { display: none; }
        .button { padding: 8px 16px; font-size: 0.9rem; font-weight: 600; border-radius: 7px; color: #fff; border: none; cursor: pointer; width: 100%; transition: all 0.2s ease; }
        .button:disabled { background: #718096 !important; cursor: not-allowed; }
        .blinking-border { animation: blink-animation 1s steps(5, start) infinite; }
        @keyframes blink-animation { to { border-color: transparent; } }
        #emergency-details-container { margin-top: 15px; text-align: left; font-size: 0.8rem; max-height: 180px; overflow-y: auto; border-top: 1px solid var(--border-color); padding-top: 10px; font-family: 'SF Mono', 'Consolas', monospace; }
        .detail-item { display: flex; justify-content: space-between; margin-bottom: 4px; padding: 2px 4px; border-radius: 3px; }
        #sites-list { list-style: none; padding: 0; margin: 10px 0 0 0; max-height: 260px; overflow-y: auto; }
        .site-item { padding: 10px; border-radius: 6px; border-bottom: 1px solid #4A5568; cursor: pointer; transition: background-color 0.2s; }
        .site-item:last-child { border-bottom: none; }
        /* [UPDATED] Styles for hover and selection */
        .site-item.hovered { background-color: var(--color-info); } /* Blue-ish for hover */
        .site-item.selected { background-color: #4A5568; border-left: 4px solid var(--color-highlight); padding-left: 6px; } /* Persistent highlight for selected */
        .site-item-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .site-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .site-score { font-size: 0.9em; padding: 3px 7px; border-radius: 10px; }
        .site-details { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="left-stack">
        <div id="telemetry-panel" class="panel">
            <strong>FG Status:</strong> <span id="fgstatus" style="color:var(--color-danger); font-weight: bold;">Offline</span>
            <button id="launch-fg" class="button" style="background-color:var(--color-info); margin-top:10px;">Launch FlightGear</button>
            <button id="recenter-map" class="button" style="background-color:var(--color-secondary); margin-top:10px;">Re-center on Plane</button>
        </div>
    </div>
    <div id="right-stack">
        <div id="emergency-panel" class="panel">
            <div id="status-display" style="text-align: center; margin-bottom: 15px;">
                <div id="emergency-type" style="font-size: 1.6rem; font-weight: bold;">AWAITING CONNECTION</div>
                <div id="emergency-details" style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">Launch or connect to simulation.</div>
            </div>
            <div id="emergency-details-container"></div>
            <button id="find-sites" class="button" style="background-color:var(--color-secondary); margin-top:15px;">Find Landing Sites</button>
        </div>
        <div id="sites-panel" class="panel">
            <div style="font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 5px;">PRIORITIZED SITES</div>
            <ul id="sites-list"></ul>
        </div>
    </div>

<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([64.05, -22.5], 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(map);
    const planeIcon = L.divIcon({ className: '', html: '<div id="plane-marker" class="plane-emoji">✈️</div>', iconSize: [40, 40], iconAnchor: [20, 20] });
    let planeMarker = L.marker([64.05, -22.5], {icon: planeIcon}).addTo(map);
    let flightTrail = L.polyline([], { color: 'rgba(163, 191, 250, 0.6)', weight: 3 }).addTo(map);

    let selectedSiteId = null, flightPathLayer = null;
    let sitesLayerGroup = L.geoJSON(null).addTo(map);
    let siteSearchTriggered = false, isFollowingPlane = true;
    let mapSiteLayers = {}; // [NEW] Store references to Leaflet layers by siteId

    const ui = {
        fgStatus: document.getElementById('fgstatus'),
        launchFgBtn: document.getElementById('launch-fg'),
        recenterBtn: document.getElementById('recenter-map'),
        emergencyPanel: document.getElementById('emergency-panel'),
        emergencyType: document.getElementById('emergency-type'),
        emergencyDetails: document.getElementById('emergency-details'),
        detailsContainer: document.getElementById('emergency-details-container'),
        findSitesBtn: document.getElementById('find-sites'),
        sitesPanel: document.getElementById('sites-panel'),
        sitesList: document.getElementById('sites-list'),
    };

    const EmergencyPattern = {
        0: 'NORMAL', 1: 'ENGINE_DEGRADATION', 2: 'FUEL_LEAK',
        3: 'STRUCTURAL_FATIGUE', 4: 'ELECTRICAL_FAILURE',
        5: 'WEATHER_DISTRESS', 6: 'SYSTEM_CASCADE', 7: 'LOSS_OF_CONTROL'
    };

    function updateHUD(data) {
        if (!data || !data.lat) return;
        const pos = L.latLng(data.lat, data.lng);
        planeMarker.setLatLng(pos);
        document.getElementById('plane-marker').style.transform = `rotate(${data.heading || 0}deg)`;
        const trailCoords = flightTrail.getLatLngs();
        if (!trailCoords.length || pos.distanceTo(trailCoords[trailCoords.length - 1]) > 20) {
            trailCoords.push(pos);
            if (trailCoords.length > 300) trailCoords.shift();
            flightTrail.setLatLngs(trailCoords);
        }
        // [FIX] Ensure map follows plane if isFollowingPlane is true
        if (isFollowingPlane) {
            map.panTo(pos, { animate: true, duration: 0.5 });
        }
        
        const isConnected = data.fg_connected === true;
        ui.fgStatus.textContent = isConnected ? "Online" : "Offline";
        ui.fgStatus.style.color = isConnected ? 'var(--color-normal)' : 'var(--color-danger)';
        ui.launchFgBtn.disabled = isConnected;
        updateEmergencyStatus(data);
        updateTelemetryDetails(data);
    }

    function updateEmergencyStatus(data) {
        const emergency = data.emergency_result || {};
        const status = data.system_status || {};
        const type = EmergencyPattern[emergency.pattern_type] || 'NORMAL';
        const isEmergency = type !== 'NORMAL' && type !== 'GRACE_PERIOD';

        ui.emergencyPanel.className = 'panel';
        ui.emergencyType.style.color = 'var(--text-primary)';
        ui.findSitesBtn.className = 'button';
        ui.findSitesBtn.style.backgroundColor = 'var(--color-secondary)';
        ui.findSitesBtn.textContent = 'Find Landing Sites';

        if (data.fg_connected && status.grace_period_remaining > 0) {
            ui.emergencyType.textContent = 'GRACE PERIOD';
            ui.emergencyDetails.textContent = `${status.grace_period_remaining.toFixed(1)}s remaining`;
            ui.emergencyType.style.color = 'var(--color-warning)';
        } else if (isEmergency) {
            ui.emergencyType.textContent = type.replace(/_/g, ' ');
            ui.emergencyDetails.textContent = `Confidence: ${(emergency.probability * 100).toFixed(0)}%`;
            ui.emergencyType.style.color = 'var(--color-danger)';
            ui.emergencyPanel.classList.add('blinking-border');
            ui.emergencyPanel.style.borderColor = 'var(--color-danger)';
            ui.findSitesBtn.style.backgroundColor = 'var(--color-danger)';
            if (!siteSearchTriggered) {
                findAndDisplaySites();
                siteSearchTriggered = true;
            }
        } else if (type === 'NORMAL') {
            ui.emergencyType.style.color = 'var(--color-normal)';
            ui.emergencyDetails.textContent = 'All systems nominal.';
        } else if (!data.fg_connected){
            ui.emergencyType.textContent = 'AWAITING CONNECTION';
            ui.emergencyDetails.textContent = 'Launch or connect to simulation.';
        }
    }

    function updateTelemetryDetails(data) {
        const telemetry = data.raw_telemetry || {};
        const scores = data.anomaly_scores || {};
        const orderedKeys = [
            'rpm', 'oil_pressure', 'fuel_flow', 'g_load', 'vibration', 
            'bus_volts', 'oil_temp', 'cht', 'egt', 'airspeed', 'yaw_rate', 
            'roll', 'pitch', 'control_asymmetry'
        ];
        ui.detailsContainer.innerHTML = '';
        if (Object.keys(telemetry).length > 0) {
            orderedKeys.forEach(key => {
                if(telemetry.hasOwnProperty(key)) {
                    const score = (scores[key] && scores[key].normalized_score !== undefined) ? scores[key].normalized_score : 0;
                    const scoreColor = score > 0.7 ? 'var(--color-danger)' : (score > 0.5 ? 'var(--color-warning)' : 'var(--text-secondary)');
                    const item = document.createElement('div');
                    item.className = 'detail-item';
                    if (score > 0.5) item.style.backgroundColor = 'rgba(255, 69, 0, 0.2)';
                    item.innerHTML = `<span style="color:var(--text-secondary)">${key.replace(/_/g, ' ').toUpperCase()}</span><span><span style="font-weight:bold">${telemetry[key].toFixed(2)}</span><span style="color:${scoreColor};font-weight:bold;width:45px;display:inline-block;text-align:right">(${(score * 100).toFixed(0)}%)</span></span>`;
                    ui.detailsContainer.appendChild(item);
                }
            });
        } else {
            ui.detailsContainer.innerHTML = `<div style="color: var(--text-secondary); text-align: center;">Awaiting telemetry...</div>`;
        }
    }

    function findAndDisplaySites() {
        isFollowingPlane = false;
        ui.findSitesBtn.disabled = true;
        ui.findSitesBtn.textContent = "Searching...";
        fetch('/sites').then(res => res.ok ? res.json() : Promise.reject('Failed to load sites')).then(geojson => {
            geojson.features.sort((a, b) => (b.properties.priority_score || 0) - (a.properties.priority_score || 0));
            sitesLayerGroup.clearLayers();
            ui.sitesList.innerHTML = '';
            mapSiteLayers = {}; // Clear map layer references

            sitesLayerGroup = L.geoJSON(geojson, {
                style: f => ({ color: f.properties.display_color, weight: 2, fillOpacity: 0.6 }),
                onEachFeature: (feature, layer) => {
                    const siteId = feature.properties.id;
                    mapSiteLayers[siteId] = layer; // Store reference to the layer

                    layer.on({
                        click: () => handleSiteClick(feature, layer),
                        mouseover: (e) => highlightSite(siteId, true, e),
                        mouseout: (e) => highlightSite(siteId, false, e),
                    });
                    addSiteToList(feature, layer);
                }
            }).addTo(map);

            if (geojson.features.length > 0) {
                map.fitBounds(sitesLayerGroup.getBounds().extend(planeMarker.getLatLng()).pad(0.2));
                ui.sitesPanel.style.display = 'block';
            }
        }).finally(() => { ui.findSitesBtn.disabled = false; });
    }

    function addSiteToList(feature, layer) {
        const props = feature.properties;
        const listItem = document.createElement('li');
        listItem.className = 'site-item';
        listItem.dataset.siteId = props.id; // Link list item to site ID
        const score = (props.safety_report.safety_score || 0).toFixed(0);
        const scoreColor = props.display_color;
        const textColor = ['#FFFF00','#FFA500'].includes(scoreColor) ? '#333' : '#FFF';

        listItem.innerHTML = `<div class="site-item-header"><span class="site-name">${props.name}</span><span class="site-score" style="background-color:${scoreColor};color:${textColor};">${score}</span></div><div class="site-details">${props.type.replace(/_/g, ' ')} &bull; ${(props.length_m||0).toFixed(0)}m</div>`;
        
        listItem.addEventListener('click', () => handleSiteClick(feature, layer));
        listItem.addEventListener('mouseover', () => highlightSite(props.id, true));
        listItem.addEventListener('mouseout', () => highlightSite(props.id, false));
        
        ui.sitesList.appendChild(listItem);
    }

    function highlightSite(siteId, isHighlighted, event = null) {
        const mapLayer = mapSiteLayers[siteId];
        const listItem = document.querySelector(`.site-item[data-site-id='${siteId}']`);
        if (!mapLayer || !listItem) return;

        // Apply hovered class to list item
        listItem.classList.toggle('hovered', isHighlighted);
        
        // Don't change map layer style if it's currently selected
        if (selectedSiteId === siteId) return;

        if (isHighlighted) {
            mapLayer.setStyle({ color: 'var(--color-glow)', weight: 4, opacity: 1 });
            mapLayer.bringToFront(); // Bring hovered layer to front
        } else {
            // Revert to original style
            mapLayer.setStyle({ color: mapLayer.feature.properties.display_color, weight: 2, opacity: 0.6 });
        }
    }

    function handleSiteClick(feature, layer) {
        // Clear previous selection visually
        if (selectedSiteId !== null) {
            const oldLayer = mapSiteLayers[selectedSiteId];
            if (oldLayer) oldLayer.setStyle({ weight: 2, color: oldLayer.feature.properties.display_color, opacity: 0.6 });
            const oldListItem = document.querySelector(`.site-item[data-site-id='${selectedSiteId}']`);
            if (oldListItem) oldListItem.classList.remove('selected');
        }

        // Apply new selection visually
        selectedSiteId = feature.properties.id;
        const newListItem = document.querySelector(`.site-item[data-site-id='${selectedSiteId}']`);
        if (newListItem) newListItem.classList.add('selected');
        
        layer.setStyle({ weight: 5, color: 'var(--color-highlight)', opacity: 1 }); // Persistent selected style
        layer.bringToFront();

        // Call the original function for the FIRST plan
        planAndDisplayPath(selectedSiteId);
    }
    
    function planAndDisplayPath(siteId) {
        // This function now handles the INITIAL path display and fits the view.
        isFollowingPlane = false; 
        fetch('/plan_path', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ site_id: siteId }) })
        .then(res => res.ok ? res.json() : Promise.reject('Path planning failed')).then(data => {
            if (data && data.waypoints && data.waypoints.length > 0) {
                if (flightPathLayer) flightPathLayer.remove();
                flightPathLayer = L.polyline(data.waypoints, { color: '#00FFFF', weight: 4, opacity: 0.9, dashArray: '5, 10' }).addTo(map);
                
                // Fit bounds only on the first click
                map.fitBounds(L.latLngBounds([planeMarker.getLatLng(), ...data.waypoints]).pad(0.2));
            }
        });
    }

    ui.launchFgBtn.addEventListener('click', () => {
        ui.launchFgBtn.disabled = true;
        ui.launchFgBtn.textContent = "Launching...";
        fetch('/launch_fg', { method: 'POST' }).then(r => r.json())
            .then(data => { if (!data.success) alert("Launch failed: " + data.error); })
            .finally(() => { ui.launchFgBtn.textContent = "Launch FlightGear"; });
    });
    
    map.on('dragstart zoomstart', () => { isFollowingPlane = false; });
    ui.recenterBtn.addEventListener('click', () => {
        isFollowingPlane = true;
        // [FIX] Explicitly pan to plane's current position when recenter is clicked
        if (planeMarker) map.setView(planeMarker.getLatLng(), map.getZoom(), {animate: true, duration: 0.5});
        // The setInterval in updateHUD will keep it centered if isFollowingPlane is true
    });

    ui.findSitesBtn.addEventListener('click', findAndDisplaySites);
    setInterval(() => { fetch('/position').then(r => r.json()).then(updateHUD); }, 500);

     function updatePath() {
        // If no site is selected, do nothing.
        if (selectedSiteId === null) return;

        // This function will silently update the path without moving the camera.
        fetch('/plan_path', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ site_id: selectedSiteId }) })
        .then(res => res.ok ? res.json() : Promise.resolve(null)) // Don't throw error on failure
        .then(data => {
            if (data && data.waypoints && data.waypoints.length > 0) {
                // If a path layer exists, just update its coordinates. Otherwise, create it.
                if (flightPathLayer) {
                    flightPathLayer.setLatLngs(data.waypoints);
                } else {
                    flightPathLayer = L.polyline(data.waypoints, { color: '#00FFFF', weight: 4, opacity: 0.9, dashArray: '5, 10' }).addTo(map);
                }
            }
        });
    }

    setInterval(updatePath, 2500);

</script>
</body>
</html>
